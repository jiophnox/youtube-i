
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Watch - YouTube</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', Arial, sans-serif;
      background-color: #0f0f0f;
      color: #fff;
      min-height: 100vh;
    }

    /* Header */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 56px;
      background: #0f0f0f;
      border-bottom: 1px solid #272727;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      z-index: 1000;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .menu-toggle {
      display: none;
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .menu-toggle:hover {
      background: #272727;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      color: #fff;
      font-size: 20px;
      font-weight: 700;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: #ff0000;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Search Bar - Desktop */
    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
      max-width: 600px;
      padding: 0 16px;
    }

    .search-container {
      display: flex;
      width: 100%;
      max-width: 500px;
    }

    .search-input-wrapper {
      flex: 1;
      position: relative;
      display: flex;
    }

    .search-input {
      width: 100%;
      height: 40px;
      background: #121212;
      border: 1px solid #303030;
      border-radius: 20px 0 0 20px;
      padding: 0 16px;
      font-size: 16px;
      color: #fff;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .search-input:focus {
      border-color: #1c62b9;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.3);
    }

    .search-input::placeholder {
      color: #888;
    }

    .search-btn {
      height: 40px;
      width: 64px;
      background: #222;
      border: 1px solid #303030;
      border-left: none;
      border-radius: 0 20px 20px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .search-btn:hover {
      background: #333;
    }

    .search-btn svg {
      width: 24px;
      height: 24px;
      fill: #fff;
    }

    /* Header Right */
    .header-right {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      flex-shrink: 0;
      min-width: 40px;
    }

    .mobile-search-btn {
      display: none;
      background: none;
      border: none;
      color: #fff;
      padding: 8px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.2s;
    }

    .mobile-search-btn:hover {
      background: #272727;
    }

    .mobile-search-btn svg {
      width: 24px;
      height: 24px;
      fill: #fff;
      display: block;
    }

    /* Mobile Search Bar */
    .mobile-search-container {
      display: none;
      position: fixed;
      top: 56px;
      left: 0;
      right: 0;
      background: #0f0f0f;
      padding: 12px 16px;
      border-bottom: 1px solid #272727;
      z-index: 999;
      animation: slideDown 0.2s ease;
    }

    .mobile-search-container.open {
      display: block;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .mobile-search-wrapper {
      display: flex;
      gap: 8px;
    }

    .mobile-search-input {
      flex: 1;
      height: 40px;
      background: #121212;
      border: 1px solid #303030;
      border-radius: 20px;
      padding: 0 16px;
      font-size: 16px;
      color: #fff;
      outline: none;
    }

    .mobile-search-input:focus {
      border-color: #1c62b9;
    }

    .mobile-search-input::placeholder {
      color: #888;
    }

    .mobile-search-submit {
      height: 40px;
      width: 40px;
      background: #222;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      flex-shrink: 0;
    }

    .mobile-search-submit:hover {
      background: #333;
    }

    .mobile-search-submit svg {
      width: 20px;
      height: 20px;
      fill: #fff;
    }

    .mobile-search-close {
      height: 40px;
      width: 40px;
      background: none;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 24px;
      transition: background 0.2s;
      flex-shrink: 0;
    }

    .mobile-search-close:hover {
      background: #272727;
    }

    /* Left Menu */
    .left-menu {
      position: fixed;
      top: 56px;
      left: 0;
      width: 150px;
      height: calc(100vh - 56px);
      background: #0f0f0f;
      border-right: 1px solid #272727;
      padding: 12px 0;
      overflow-y: auto;
      z-index: 999;
      transition: transform 0.3s ease;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .left-menu::-webkit-scrollbar {
      display: none;
    }

    .menu-overlay {
      display: none;
      position: fixed;
      top: 56px;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 998;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      color: #fff;
      text-decoration: none;
      font-size: 13px;
      transition: background 0.2s;
      cursor: pointer;
    }

    .menu-item:hover {
      background: #272727;
    }

    .menu-item.active {
      background: #272727;
    }

    .menu-item-icon {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .menu-divider {
      height: 1px;
      background: #272727;
      margin: 12px 0;
    }

    .menu-section-title {
      padding: 8px 16px;
      font-size: 11px;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Main Content Wrapper */
    .main-wrapper {
      margin-left: 150px;
      padding-top: 56px;
      min-height: 100vh;
    }

    /* ==================== SKELETON LOADING STYLES ==================== */
    @keyframes shimmer {
      0% {
        background-position: -200% 0;
      }
      100% {
        background-position: 200% 0;
      }
    }

    .skeleton {
      background: linear-gradient(
        90deg,
        #1f1f1f 0%,
        #2a2a2a 25%,
        #1f1f1f 50%,
        #2a2a2a 75%,
        #1f1f1f 100%
      );
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
      border-radius: 4px;
    }

    .skeleton-text {
      height: 14px;
      margin-bottom: 8px;
    }

    .skeleton-text.small {
      height: 12px;
    }

    .skeleton-text.large {
      height: 20px;
    }

    .skeleton-text.xlarge {
      height: 24px;
    }

    /* Skeleton Loading Container */
    .skeleton-container {
      display: block;
    }

    .skeleton-container.hidden {
      display: none !important;
    }

    /* Player Skeleton */
    .skeleton-player {
      width: 100%;
      aspect-ratio: 16/9;
      border-radius: 12px;
    }

    /* Video Info Skeleton */
    .skeleton-video-info {
      padding: 16px 0;
    }

    .skeleton-title {
      height: 24px;
      width: 80%;
      margin-bottom: 16px;
    }

    .skeleton-title-line2 {
      height: 24px;
      width: 50%;
      margin-bottom: 16px;
    }

    .skeleton-stats {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .skeleton-meta {
      display: flex;
      gap: 12px;
    }

    .skeleton-meta-item {
      height: 14px;
      width: 80px;
    }

    .skeleton-actions {
      display: flex;
      gap: 8px;
    }

    .skeleton-action-btn {
      height: 40px;
      width: 80px;
      border-radius: 20px;
    }

    .skeleton-action-btn.wide {
      width: 100px;
    }

    /* Channel Skeleton */
    .skeleton-channel-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid #272727;
      flex-wrap: wrap;
      gap: 12px;
    }

    .skeleton-channel-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .skeleton-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
    }

    .skeleton-channel-details {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .skeleton-channel-name {
      height: 16px;
      width: 120px;
    }

    .skeleton-channel-subs {
      height: 12px;
      width: 80px;
    }

    .skeleton-subscribe-btn {
      height: 40px;
      width: 110px;
      border-radius: 20px;
    }

    /* Description Skeleton */
    .skeleton-description {
      background: #181818;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }

    .skeleton-desc-meta {
      height: 14px;
      width: 200px;
      margin-bottom: 12px;
    }

    .skeleton-desc-line {
      height: 14px;
      margin-bottom: 8px;
    }

    .skeleton-desc-line:nth-child(2) {
      width: 100%;
    }

    .skeleton-desc-line:nth-child(3) {
      width: 95%;
    }

    .skeleton-desc-line:nth-child(4) {
      width: 70%;
    }

    /* Comments Skeleton */
    .skeleton-comments-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #272727;
    }

    .skeleton-comments-header {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-bottom: 24px;
    }

    .skeleton-comments-count {
      height: 16px;
      width: 120px;
    }

    .skeleton-sort-btn {
      height: 32px;
      width: 60px;
      border-radius: 16px;
    }

    .skeleton-add-comment {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }

    .skeleton-add-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .skeleton-add-input {
      flex: 1;
      height: 36px;
      border-radius: 0;
      border-bottom: 2px solid #272727;
      background: transparent;
    }

    .skeleton-comment-item {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .skeleton-comment-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .skeleton-comment-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .skeleton-comment-header {
      display: flex;
      gap: 8px;
    }

    .skeleton-comment-author {
      height: 13px;
      width: 100px;
    }

    .skeleton-comment-time {
      height: 12px;
      width: 60px;
    }

    .skeleton-comment-text {
      height: 14px;
      width: 90%;
    }

    .skeleton-comment-text-2 {
      height: 14px;
      width: 70%;
    }

    .skeleton-comment-actions {
      display: flex;
      gap: 12px;
      margin-top: 4px;
    }

    .skeleton-comment-action {
      height: 24px;
      width: 50px;
      border-radius: 12px;
    }

    /* Related Videos Skeleton */
    .skeleton-related-section {
      background: #181818;
      border-radius: 12px;
      overflow: hidden;
    }

    .skeleton-related-header {
      padding: 16px;
      border-bottom: 1px solid #272727;
    }

    .skeleton-related-title {
      height: 16px;
      width: 120px;
    }

    .skeleton-related-videos {
      padding: 8px 0;
    }

    .skeleton-related-item {
      display: flex;
      gap: 8px;
      padding: 8px 12px;
    }

    .skeleton-related-thumb {
      width: 168px;
      aspect-ratio: 16/9;
      border-radius: 8px;
      flex-shrink: 0;
    }

    .skeleton-related-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding-top: 2px;
    }

    .skeleton-related-video-title {
      height: 14px;
      width: 100%;
    }

    .skeleton-related-video-title-2 {
      height: 14px;
      width: 80%;
    }

    .skeleton-related-channel {
      height: 12px;
      width: 70%;
      margin-top: 4px;
    }

    .skeleton-related-meta {
      height: 12px;
      width: 60%;
    }

    /* Mobile Comments Bar Skeleton */
    .skeleton-mobile-comments-bar {
      display: none;
      background: #181818;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }

    .skeleton-mobile-comments-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .skeleton-mobile-comments-title {
      height: 14px;
      width: 100px;
    }

    .skeleton-mobile-comments-arrow {
      height: 14px;
      width: 14px;
    }

    .skeleton-mobile-comments-preview {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .skeleton-mobile-preview-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .skeleton-mobile-preview-text {
      flex: 1;
      height: 32px;
      border-radius: 4px;
    }

    /* Watch Layout */
    .watch-container {
      display: flex;
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px;
      gap: 24px;
    }

    /* Video Player Section */
    .player-section {
      flex: 1;
      min-width: 0;
    }

    /* ==================== VIDEO PLAYER - BLACK SCREEN FIX ==================== */
    .video-player-container {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      /* Force GPU compositing layer - prevents black screen on tab switch */
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      isolation: isolate;
      contain: layout style paint;
    }

    /* YouTube iframe player */
    #player {
      width: 100%;
      height: 100%;
      position: relative;
      z-index: 1;
      /* Force compositing layer */
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    /* Ensure iframe inside player stays rendered */
    #player iframe,
    .video-player-container iframe {
      width: 100%;
      height: 100%;
      border: none;
      position: relative;
      z-index: 1;
      /* Prevent black screen on visibility change */
      transform: translate3d(0, 0, 0);
      -webkit-transform: translate3d(0, 0, 0);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    /* Player Placeholder - positioned absolutely so it doesn't affect iframe */
    .player-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #aaa;
      text-align: center;
      padding: 40px;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0;
    }

    .player-placeholder.hidden {
      display: none;
    }

    .player-placeholder-icon {
      font-size: 64px;
      margin-bottom: 24px;
      opacity: 0.5;
    }

    .player-placeholder h2 {
      font-size: 24px;
      color: #fff;
      margin-bottom: 12px;
    }

    .player-placeholder p {
      font-size: 14px;
      max-width: 400px;
      line-height: 1.6;
    }

    /* ==================== HIDDEN CLASS FIX ==================== */
    /* Default hidden behavior */
    .hidden {
      display: none !important;
    }

    /* Special handling for content container - preserve iframe rendering */
    #content.hidden {
      display: block !important;
      visibility: hidden;
      position: absolute;
      width: 100%;
      height: 0;
      overflow: hidden;
      pointer-events: none;
      opacity: 0;
    }

    #content:not(.hidden) {
      display: block;
      visibility: visible;
      position: relative;
      height: auto;
      overflow: visible;
      pointer-events: auto;
      opacity: 1;
    }

    /* Video Info */
    .video-info {
      padding: 16px 0;
    }

    .video-title {
      font-size: 20px;
      font-weight: 600;
      line-height: 1.4;
      margin-bottom: 12px;
      color: #f1f1f1;
    }

    .video-stats {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .video-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #aaa;
      font-size: 14px;
    }

    .video-meta span::after {
      content: '•';
      margin-left: 8px;
    }

    .video-meta span:last-child::after {
      content: '';
    }

    .video-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: #272727;
      border: none;
      border-radius: 20px;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
      white-space: nowrap;
    }

    .action-btn:hover {
      background: #3f3f3f;
    }

    .action-btn.liked {
      background: #3ea6ff;
      color: #000;
    }

    /* Channel Info */
    .channel-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid #272727;
      flex-wrap: wrap;
      gap: 12px;
    }

    .channel-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .channel-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #333;
      object-fit: cover;
    }

    .channel-details h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .channel-details h3 a {
      color: #fff;
      text-decoration: none;
      transition: color 0.2s;
    }

    .channel-details h3 a:hover {
      color: #3ea6ff;
    }

    .channel-subs {
      font-size: 12px;
      color: #aaa;
    }

    .channel-buttons {
      display: flex;
      gap: 8px;
    }

    .subscribe-btn {
      padding: 10px 20px;
      background: #fff;
      color: #0f0f0f;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .subscribe-btn:hover {
      background: #d9d9d9;
    }

    .subscribe-btn.subscribed {
      background: #272727;
      color: #fff;
    }

    /* Description */
    .description-box {
      background: #272727;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .description-box:hover {
      background: #3f3f3f;
    }

    .description-box.expanded {
      cursor: default;
    }

    .description-box.expanded:hover {
      background: #272727;
    }

    .description-meta {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #f1f1f1;
    }

    .description-text {
      font-size: 14px;
      line-height: 1.6;
      color: #f1f1f1;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .description-text:not(.expanded) {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .description-hashtags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .hashtag {
      color: #3ea6ff;
      font-size: 13px;
      text-decoration: none;
    }

    .hashtag:hover {
      text-decoration: underline;
    }

    .show-more-btn {
      background: none;
      border: none;
      color: #aaa;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 12px;
      padding: 0;
    }

    .show-more-btn:hover {
      color: #fff;
    }

    /* Comments Section */
    .comments-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #272727;
    }

    .comments-header {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-bottom: 24px;
    }

    .comments-count {
      font-size: 16px;
      font-weight: 500;
    }

    .comments-sort {
      display: flex;
      align-items: center;
      gap: 8px;
      background: none;
      border: none;
      color: #f1f1f1;
      font-size: 14px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 20px;
      transition: background 0.2s;
    }

    .comments-sort:hover {
      background: #272727;
    }

    .comments-sort.active {
      background: #272727;
    }

    .add-comment {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }

    .add-comment-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #3ea6ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .add-comment-input-wrapper {
      flex: 1;
    }

    .add-comment-input {
      width: 100%;
      background: none;
      border: none;
      border-bottom: 1px solid #272727;
      color: #fff;
      font-size: 14px;
      padding: 8px 0;
      outline: none;
      transition: border-color 0.2s;
    }

    .add-comment-input:focus {
      border-color: #fff;
    }

    .add-comment-input::placeholder {
      color: #717171;
    }

    .add-comment-actions {
      display: none;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 8px;
    }

    .add-comment-actions.show {
      display: flex;
    }

    .comment-cancel-btn {
      padding: 8px 16px;
      background: none;
      border: none;
      color: #f1f1f1;
      font-size: 14px;
      cursor: pointer;
      border-radius: 18px;
    }

    .comment-cancel-btn:hover {
      background: #272727;
    }

    .comment-submit-btn {
      padding: 8px 16px;
      background: #3ea6ff;
      border: none;
      color: #0f0f0f;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 18px;
      opacity: 0.5;
      pointer-events: none;
    }

    .comment-submit-btn.active {
      opacity: 1;
      pointer-events: auto;
    }

    .comments-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Comment Item */
    .comment-item {
      display: flex;
      gap: 12px;
    }

    .comment-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #333;
      object-fit: cover;
      flex-shrink: 0;
    }

    .comment-content {
      flex: 1;
      min-width: 0;
    }

    .comment-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .comment-author {
      font-size: 13px;
      font-weight: 500;
      color: #f1f1f1;
      text-decoration: none;
    }

    .comment-author:hover {
      color: #3ea6ff;
    }

    .comment-author.owner {
      background: #272727;
      padding: 2px 8px;
      border-radius: 12px;
    }

    .comment-author.verified::after {
      content: '✓';
      margin-left: 4px;
      color: #aaa;
      font-size: 12px;
    }

    .comment-time {
      font-size: 12px;
      color: #aaa;
    }

    .comment-badges {
      display: flex;
      gap: 4px;
    }

    .comment-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      background: #272727;
      color: #aaa;
    }

    .comment-badge.pinned {
      background: #3ea6ff20;
      color: #3ea6ff;
    }

    .comment-badge.hearted {
      background: #ff000020;
      color: #ff0000;
    }

    .comment-text {
      font-size: 14px;
      line-height: 1.5;
      color: #f1f1f1;
      white-space: pre-wrap;
      word-break: break-word;
      margin-bottom: 8px;
    }

    .comment-text.collapsed {
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .comment-read-more {
      background: none;
      border: none;
      color: #aaa;
      font-size: 13px;
      cursor: pointer;
      padding: 0;
      margin-bottom: 8px;
    }

    .comment-read-more:hover {
      color: #fff;
    }

    .comment-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .comment-action-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      background: none;
      border: none;
      color: #aaa;
      font-size: 13px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 16px;
      transition: background 0.2s;
    }

    .comment-action-btn:hover {
      background: #272727;
    }

    .comment-reply-btn {
      background: none;
      border: none;
      color: #aaa;
      font-size: 13px;
      cursor: pointer;
      padding: 4px 12px;
      border-radius: 16px;
    }

    .comment-reply-btn:hover {
      background: #272727;
    }

    .comment-replies-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      background: none;
      border: none;
      color: #3ea6ff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      padding: 8px 0;
      margin-top: 4px;
    }

    .comment-replies-toggle:hover {
      color: #65b8ff;
    }

    .comments-loading {
      display: flex;
      justify-content: center;
      padding: 24px;
    }

    .comments-end {
      text-align: center;
      padding: 24px;
      color: #717171;
      font-size: 14px;
    }

    /* Mobile Comments Bar (Collapsed) */
    .mobile-comments-bar {
      display: none;
      background: #272727;
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .mobile-comments-bar:hover {
      background: #3f3f3f;
    }

    .mobile-comments-bar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .mobile-comments-bar-title {
      font-size: 14px;
      font-weight: 500;
      color: #f1f1f1;
    }

    .mobile-comments-bar-arrow {
      color: #aaa;
      font-size: 18px;
    }

    .mobile-comments-preview {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .mobile-comments-preview-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #333;
      flex-shrink: 0;
    }

    .mobile-comments-preview-text {
      font-size: 13px;
      color: #aaa;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Mobile Comments Modal */
    .mobile-comments-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #0f0f0f;
      z-index: 2000;
      flex-direction: column;
    }

    .mobile-comments-modal.open {
      display: flex;
    }

    .mobile-comments-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid #272727;
      flex-shrink: 0;
    }

    .mobile-comments-modal-title {
      font-size: 16px;
      font-weight: 500;
    }

    .mobile-comments-modal-close {
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mobile-comments-modal-close:hover {
      background: #272727;
    }

    .mobile-comments-modal-sort {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-bottom: 1px solid #272727;
      flex-shrink: 0;
    }

    .mobile-comments-modal-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .mobile-comments-modal-add {
      display: flex;
      gap: 12px;
      padding: 12px 16px;
      border-top: 1px solid #272727;
      background: #181818;
      flex-shrink: 0;
    }

    .mobile-comments-modal-add input {
      flex: 1;
      background: #272727;
      border: none;
      border-radius: 20px;
      padding: 10px 16px;
      color: #fff;
      font-size: 14px;
      outline: none;
    }

    .mobile-comments-modal-add input::placeholder {
      color: #717171;
    }

    /* Sidebar */
    .sidebar {
      width: 400px;
      flex-shrink: 0;
    }

    /* Playlist Panel */
    .playlist-panel {
      background: #181818;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .playlist-panel.hidden {
      display: none;
    }

    .playlist-header {
      background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
      padding: 16px;
    }

    .playlist-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .playlist-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      color: #aaa;
      margin-bottom: 4px;
    }

    .playlist-author a {
      color: #aaa;
      text-decoration: none;
    }

    .playlist-author a:hover {
      color: #fff;
    }

    .playlist-progress {
      color: #fff;
      font-weight: 500;
    }

    .playlist-controls {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .control-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #aaa;
    }

    .control-toggle {
      position: relative;
      width: 36px;
      height: 20px;
      background: #717171;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .control-toggle.active {
      background: #3ea6ff;
    }

    .control-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 16px;
      height: 16px;
      background: #fff;
      border-radius: 50%;
      transition: left 0.2s;
    }

    .control-toggle.active::after {
      left: 18px;
    }

    .shuffle-btn {
      background: none;
      border: none;
      color: #aaa;
      font-size: 18px;
      cursor: pointer;
      padding: 4px;
      transition: color 0.2s;
    }

    .shuffle-btn:hover {
      color: #fff;
    }

    .shuffle-btn.active {
      color: #3ea6ff;
    }

    /* Playlist Videos */
    .playlist-videos {
      max-height: 300px;
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .playlist-videos::-webkit-scrollbar {
      display: none;
    }

    .playlist-video-item {
      display: flex;
      gap: 8px;
      padding: 8px 12px;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      transition: background 0.2s;
      border-left: 3px solid transparent;
    }

    .playlist-video-item:hover {
      background: #272727;
    }

    .playlist-video-item.active {
      background: #272727;
      border-left-color: #3ea6ff;
    }

    .video-index {
      width: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #aaa;
      flex-shrink: 0;
    }

    .video-index.playing {
      color: #3ea6ff;
    }

    .playlist-video-thumb {
      position: relative;
      width: 100px;
      aspect-ratio: 16/9;
      border-radius: 8px;
      overflow: hidden;
      background: #333;
      flex-shrink: 0;
    }

    .playlist-video-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .playlist-video-duration {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 1px 4px;
      border-radius: 3px;
      font-size: 11px;
    }

    .playlist-video-info {
      flex: 1;
      min-width: 0;
    }

    .playlist-video-title {
      font-size: 13px;
      font-weight: 500;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-bottom: 4px;
      color: #f1f1f1;
    }

    .playlist-video-author {
      font-size: 12px;
      color: #aaa;
    }

    /* Related Videos Section */
    .related-section {
      background: #181818;
      border-radius: 12px;
      overflow: hidden;
    }

    .related-header {
      padding: 16px;
      border-bottom: 1px solid #272727;
    }

    .related-title {
      font-size: 16px;
      font-weight: 600;
      color: #f1f1f1;
    }

    .related-videos {
      max-height: calc(100vh - 200px);
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .related-videos::-webkit-scrollbar {
      display: none;
    }

    .related-video-item {
      display: flex;
      gap: 8px;
      padding: 8px 12px;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      transition: background 0.2s;
    }

    .related-video-item:hover {
      background: #272727;
    }

    .related-video-thumb {
      position: relative;
      width: 168px;
      aspect-ratio: 16/9;
      border-radius: 8px;
      overflow: hidden;
      background: #333;
      flex-shrink: 0;
    }

    .related-video-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .related-video-duration {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 1px 4px;
      border-radius: 3px;
      font-size: 11px;
    }

    .related-video-info {
      flex: 1;
      min-width: 0;
    }

    .related-video-title {
      font-size: 14px;
      font-weight: 500;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      margin-bottom: 4px;
      color: #f1f1f1;
    }

    .related-video-channel {
      font-size: 12px;
      color: #aaa;
      margin-bottom: 2px;
    }

    .related-video-channel.verified::after {
      content: ' ✓';
      font-size: 11px;
    }

    .related-video-meta {
      font-size: 12px;
      color: #aaa;
    }

    .related-loading {
      display: flex;
      justify-content: center;
      padding: 24px;
    }

    .related-end {
      text-align: center;
      padding: 16px;
      color: #717171;
      font-size: 13px;
    }

    /* Spinner (keep for infinite scroll loading) */
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #272727;
      border-top-color: #ff0000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .spinner.small {
      width: 24px;
      height: 24px;
      border-width: 3px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Autoplay Overlay - No transform to avoid interfering with video */
    .autoplay-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .autoplay-overlay.hidden {
      display: none;
    }

    .autoplay-content {
      text-align: center;
      max-width: 400px;
      padding: 24px;
    }

    .autoplay-label {
      font-size: 12px;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 16px;
    }

    .autoplay-next-video {
      display: flex;
      gap: 12px;
      background: #272727;
      border-radius: 12px;
      padding: 12px;
      text-align: left;
      margin-bottom: 20px;
    }

    .autoplay-thumb {
      width: 120px;
      aspect-ratio: 16/9;
      border-radius: 8px;
      overflow: hidden;
      background: #333;
      flex-shrink: 0;
    }

    .autoplay-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .autoplay-info {
      flex: 1;
      min-width: 0;
    }

    .autoplay-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .autoplay-author {
      font-size: 12px;
      color: #aaa;
    }

    .autoplay-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .countdown-ring {
      position: relative;
      width: 60px;
      height: 60px;
    }

    .countdown-ring svg {
      transform: rotate(-90deg);
    }

    .countdown-ring circle {
      fill: none;
      stroke-width: 4;
    }

    .countdown-ring .bg {
      stroke: #333;
    }

    .countdown-ring .progress {
      stroke: #3ea6ff;
      stroke-linecap: round;
      transition: stroke-dashoffset 1s linear;
    }

    .countdown-number {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      font-weight: 600;
    }

    .autoplay-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .play-now-btn {
      background: #fff;
      color: #000;
    }

    .play-now-btn:hover {
      background: #d9d9d9;
    }

    .cancel-btn {
      background: #272727;
      color: #fff;
    }

    .cancel-btn:hover {
      background: #3f3f3f;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #323232;
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 3000;
      transition: transform 0.3s ease;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
    }

    /* Desktop only comments */
    .desktop-comments {
      display: block;
    }

    /* ==================== PROXY PLAYER STYLES WITH BLACK SCREEN FIX ==================== */
    .proxy-player-container {
      position: relative;
      width: 100%;
      height: 100%;
      background: #000;
      /* Force GPU compositing */
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    .proxy-player-container.hidden {
      display: none;
    }

    .proxy-player-container video {
      width: 100%;
      height: 100%;
      background: #000;
      /* Force GPU rendering */
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }

    .proxy-player-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.7);
      z-index: 5;
    }

    .proxy-player-overlay.hidden {
      display: none;
    }

    .proxy-loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid #333;
      border-top-color: #ff0000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* Quality/Format Selector */
    .format-selector {
      position: absolute;
      bottom: 60px;
      right: 10px;
      z-index: 20;
    }

    .format-selector.hidden {
      display: none;
    }

    .format-btn {
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid #555;
      color: #fff;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
    }

    .format-btn:hover {
      background: rgba(50, 50, 50, 0.9);
    }

    .format-btn svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    .format-menu {
      position: absolute;
      bottom: 100%;
      right: 0;
      background: rgba(20, 20, 20, 0.95);
      border: 1px solid #333;
      border-radius: 8px;
      min-width: 200px;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 8px;
      display: none;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);
    }

    .format-menu.open {
      display: block;
    }

    .format-menu-header {
      padding: 10px 12px;
      font-size: 12px;
      color: #888;
      border-bottom: 1px solid #333;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .format-menu-item {
      padding: 10px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      transition: background 0.2s;
      border-bottom: 1px solid #222;
    }

    .format-menu-item:last-child {
      border-bottom: none;
    }

    .format-menu-item:hover {
      background: #333;
    }

    .format-menu-item.active {
      background: #ff0000;
      color: #fff;
    }

    .format-menu-item .quality {
      font-weight: 500;
    }

    .format-menu-item .info {
      font-size: 11px;
      color: #888;
    }

    .format-menu-item.active .info {
      color: rgba(255, 255, 255, 0.8);
    }

    .format-group-title {
      padding: 8px 12px;
      font-size: 11px;
      color: #ff0000;
      background: #1a1a1a;
      text-transform: uppercase;
      font-weight: 600;
    }

    /* Proxy player badge */
    .proxy-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 0, 0, 0.8);
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .proxy-badge.hidden {
      display: none;
    }

    /* Error overlay */
    .player-error-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 15;
      padding: 20px;
      text-align: center;
    }

    .player-error-overlay.hidden {
      display: none;
    }

    .player-error-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .player-error-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .player-error-message {
      font-size: 14px;
      color: #aaa;
      margin-bottom: 20px;
      max-width: 400px;
    }

    .player-error-btn {
      background: #ff0000;
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .player-error-btn:hover {
      background: #cc0000;
    }

    /* ==================== RESPONSIVE STYLES ==================== */
    @media (max-width: 1200px) {
      .sidebar {
        width: 350px;
      }
      .related-video-thumb,
      .skeleton-related-thumb {
        width: 140px;
      }
    }

    @media (max-width: 1000px) {
      .watch-container {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        order: 2;
      }
      .player-section {
        order: 1;
      }
      .playlist-videos {
        max-height: 250px;
      }
      .related-videos {
        max-height: none;
        overflow-y: visible;
      }
      .related-video-thumb,
      .skeleton-related-thumb {
        width: 160px;
      }
    }

    @media (max-width: 768px) {
      .left-menu {
        transform: translateX(-100%);
        width: 200px;
      }
      .left-menu.open {
        transform: translateX(0);
      }
      .menu-overlay.open {
        display: block;
      }
      .main-wrapper {
        margin-left: 0;
      }
      .header-center {
        display: none;
      }
      .mobile-search-btn {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .menu-toggle {
        display: block;
      }
      .watch-container {
        padding: 0;
        gap: 0;
      }
      .player-section {
        padding: 0 0 16px 0;
      }
      .video-player-container,
      .skeleton-player {
        border-radius: 0;
        width: 100%;
        margin: 0;
        /* Keep GPU acceleration on mobile */
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
      }
      .video-info,
      .skeleton-video-info {
        padding: 16px;
      }
      .video-title {
        font-size: 16px;
      }
      .video-stats,
      .skeleton-stats {
        flex-direction: column;
        align-items: flex-start;
      }
      .video-actions,
      .skeleton-actions {
        width: 100%;
        overflow-x: auto;
        padding-bottom: 8px;
        flex-wrap: nowrap;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      .video-actions::-webkit-scrollbar,
      .skeleton-actions::-webkit-scrollbar {
        display: none;
      }
      .channel-row,
      .skeleton-channel-row {
        padding: 0 16px 16px;
        flex-direction: column;
        align-items: flex-start;
      }
      .channel-buttons {
        width: 100%;
      }
      .subscribe-btn,
      .skeleton-subscribe-btn {
        flex: 1;
        width: 100%;
      }
      .description-box,
      .skeleton-description {
        margin: 0 16px 16px;
      }

      /* Hide desktop comments, show mobile comments bar */
      .desktop-comments {
        display: none;
      }
      .mobile-comments-bar,
      .skeleton-mobile-comments-bar {
        display: block;
        margin: 0 16px 16px;
      }

      /* Sidebar adjustments */
      .sidebar {
        padding: 0 16px 16px;
      }
      .related-video-item,
      .skeleton-related-item {
        padding: 8px 0;
      }
      .related-video-thumb,
      .skeleton-related-thumb {
        width: 120px;
      }
      .related-section,
      .skeleton-related-section {
        background: transparent;
      }
      .related-header,
      .skeleton-related-header {
        padding: 16px 0;
        border-bottom: none;
      }

      /* Keep player GPU accelerated on mobile */
      #player,
      #player iframe {
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
      }
    }

    @media (max-width: 480px) {
      .action-btn span:last-child {
        display: none;
      }
      .action-btn,
      .skeleton-action-btn {
        padding: 10px 12px;
        width: 48px;
      }
      .skeleton-action-btn.wide {
        width: 48px;
      }
      .autoplay-controls {
        flex-direction: column;
        gap: 12px;
      }
      .autoplay-next-video {
        flex-direction: column;
      }
      .autoplay-thumb {
        width: 100%;
      }
      .related-video-thumb,
      .skeleton-related-thumb {
        width: 100px;
      }
    }

    /* ==================== TAB VISIBILITY FIX ==================== */
    /* Ensure video rendering is preserved during tab switches */
    @media screen {
      .video-player-container,
      #player,
      #player iframe,
      .proxy-player-container,
      .proxy-player-container video {
        /* Ensure repaint on resize/visibility change */
        contain: layout style paint;
      }

      /* Prevent compositor optimization that causes black screen */
      #player iframe {
        will-change: auto;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <button class="menu-toggle" id="menu-toggle" aria-label="Toggle menu">☰</button>
      <a href="/" class="logo">
        <div class="logo-icon">▶</div>
        <span>YouTube</span>
      </a>
    </div>

    <div class="header-center">
      <form class="search-container" id="desktop-search-form">
        <div class="search-input-wrapper">
          <input type="text" class="search-input" id="desktop-search-input" placeholder="Search" autocomplete="off">
        </div>
        <button type="submit" class="search-btn" aria-label="Search">
          <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
        </button>
      </form>
    </div>

    <div class="header-right">
      <button class="mobile-search-btn" id="mobile-search-btn" aria-label="Search">
        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
      </button>
    </div>
  </header>

  <!-- Mobile Search Bar -->
  <div class="mobile-search-container" id="mobile-search-container">
    <form class="mobile-search-wrapper" id="mobile-search-form">
      <input type="text" class="mobile-search-input" id="mobile-search-input" placeholder="Search" autocomplete="off">
      <button type="submit" class="mobile-search-submit" aria-label="Search">
        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
      </button>
      <button type="button" class="mobile-search-close" id="mobile-search-close" aria-label="Close">✕</button>
    </form>
  </div>

  <!-- Left Menu -->
  <nav class="left-menu" id="left-menu">
    <a href="/" class="menu-item"><span class="menu-item-icon">🏠</span><span>Home</span></a>
    <a href="/shorts" class="menu-item"><span class="menu-item-icon">⚡</span><span>Shorts</span></a>
    <a href="/subscriptions" class="menu-item"><span class="menu-item-icon">📺</span><span>Subscriptions</span></a>
    <div class="menu-divider"></div>
    <div class="menu-section-title">You</div>
    <a href="/history" class="menu-item"><span class="menu-item-icon">⏱️</span><span>History</span></a>
    <a href="/playlists" class="menu-item"><span class="menu-item-icon">📁</span><span>Playlists</span></a>
    <a href="/watch-later" class="menu-item"><span class="menu-item-icon">⏰</span><span>Watch later</span></a>
    <a href="/liked" class="menu-item"><span class="menu-item-icon">👍</span><span>Liked videos</span></a>
    <div class="menu-divider"></div>
    <div class="menu-section-title">Explore</div>
    <a href="/trending" class="menu-item"><span class="menu-item-icon">🔥</span><span>Trending</span></a>
    <a href="/music" class="menu-item"><span class="menu-item-icon">🎵</span><span>Music</span></a>
    <a href="/gaming" class="menu-item"><span class="menu-item-icon">🎮</span><span>Gaming</span></a>
    <a href="/sports" class="menu-item"><span class="menu-item-icon">⚽</span><span>Sports</span></a>
  </nav>

  <div class="menu-overlay" id="menu-overlay"></div>

  <!-- Main Wrapper -->
  <div class="main-wrapper">
    <!-- Skeleton Loading -->
    <div id="skeleton-loading" class="skeleton-container">
      <div class="watch-container">
        <!-- Player Section Skeleton -->
        <div class="player-section">
          <!-- Player Skeleton -->
          <div class="skeleton skeleton-player"></div>

          <!-- Video Info Skeleton -->
          <div class="skeleton-video-info">
            <div class="skeleton skeleton-title"></div>
            <div class="skeleton skeleton-title-line2"></div>
            <div class="skeleton-stats">
              <div class="skeleton-meta">
                <div class="skeleton skeleton-meta-item"></div>
                <div class="skeleton skeleton-meta-item"></div>
              </div>
              <div class="skeleton-actions">
                <div class="skeleton skeleton-action-btn wide"></div>
                <div class="skeleton skeleton-action-btn"></div>
                <div class="skeleton skeleton-action-btn"></div>
                <div class="skeleton skeleton-action-btn"></div>
              </div>
            </div>
          </div>

          <!-- Channel Skeleton -->
          <div class="skeleton-channel-row">
            <div class="skeleton-channel-info">
              <div class="skeleton skeleton-avatar"></div>
              <div class="skeleton-channel-details">
                <div class="skeleton skeleton-channel-name"></div>
                <div class="skeleton skeleton-channel-subs"></div>
              </div>
            </div>
            <div class="skeleton skeleton-subscribe-btn"></div>
          </div>

          <!-- Description Skeleton -->
          <div class="skeleton-description">
            <div class="skeleton skeleton-desc-meta"></div>
            <div class="skeleton skeleton-desc-line"></div>
            <div class="skeleton skeleton-desc-line"></div>
            <div class="skeleton skeleton-desc-line"></div>
          </div>

          <!-- Mobile Comments Bar Skeleton -->
          <div class="skeleton-mobile-comments-bar">
            <div class="skeleton-mobile-comments-header">
              <div class="skeleton skeleton-mobile-comments-title"></div>
              <div class="skeleton skeleton-mobile-comments-arrow"></div>
            </div>
            <div class="skeleton-mobile-comments-preview">
              <div class="skeleton skeleton-mobile-preview-avatar"></div>
              <div class="skeleton skeleton-mobile-preview-text"></div>
            </div>
          </div>

          <!-- Comments Section Skeleton (Desktop) -->
          <div class="skeleton-comments-section desktop-comments">
            <div class="skeleton-comments-header">
              <div class="skeleton skeleton-comments-count"></div>
              <div class="skeleton skeleton-sort-btn"></div>
              <div class="skeleton skeleton-sort-btn"></div>
            </div>
            <div class="skeleton-add-comment">
              <div class="skeleton skeleton-add-avatar"></div>
              <div class="skeleton skeleton-add-input"></div>
            </div>
            <!-- Comment Items -->
            <div class="skeleton-comment-item">
              <div class="skeleton skeleton-comment-avatar"></div>
              <div class="skeleton-comment-content">
                <div class="skeleton-comment-header">
                  <div class="skeleton skeleton-comment-author"></div>
                  <div class="skeleton skeleton-comment-time"></div>
                </div>
                <div class="skeleton skeleton-comment-text"></div>
                <div class="skeleton skeleton-comment-text-2"></div>
                <div class="skeleton-comment-actions">
                  <div class="skeleton skeleton-comment-action"></div>
                  <div class="skeleton skeleton-comment-action"></div>
                </div>
              </div>
            </div>
            <div class="skeleton-comment-item">
              <div class="skeleton skeleton-comment-avatar"></div>
              <div class="skeleton-comment-content">
                <div class="skeleton-comment-header">
                  <div class="skeleton skeleton-comment-author"></div>
                  <div class="skeleton skeleton-comment-time"></div>
                </div>
                <div class="skeleton skeleton-comment-text"></div>
                <div class="skeleton-comment-actions">
                  <div class="skeleton skeleton-comment-action"></div>
                  <div class="skeleton skeleton-comment-action"></div>
                </div>
              </div>
            </div>
            <div class="skeleton-comment-item">
              <div class="skeleton skeleton-comment-avatar"></div>
              <div class="skeleton-comment-content">
                <div class="skeleton-comment-header">
                  <div class="skeleton skeleton-comment-author"></div>
                  <div class="skeleton skeleton-comment-time"></div>
                </div>
                <div class="skeleton skeleton-comment-text"></div>
                <div class="skeleton skeleton-comment-text-2"></div>
                <div class="skeleton-comment-actions">
                  <div class="skeleton skeleton-comment-action"></div>
                  <div class="skeleton skeleton-comment-action"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar Skeleton -->
        <div class="sidebar">
          <div class="skeleton-related-section">
            <div class="skeleton-related-header">
              <div class="skeleton skeleton-related-title"></div>
            </div>
            <div class="skeleton-related-videos">
              <!-- Related Video Items -->
              <div class="skeleton-related-item">
                <div class="skeleton skeleton-related-thumb"></div>
                <div class="skeleton-related-info">
                  <div class="skeleton skeleton-related-video-title"></div>
                  <div class="skeleton skeleton-related-video-title-2"></div>
                  <div class="skeleton skeleton-related-channel"></div>
                  <div class="skeleton skeleton-related-meta"></div>
                </div>
              </div>
              <div class="skeleton-related-item">
                <div class="skeleton skeleton-related-thumb"></div>
                <div class="skeleton-related-info">
                  <div class="skeleton skeleton-related-video-title"></div>
                  <div class="skeleton skeleton-related-video-title-2"></div>
                  <div class="skeleton skeleton-related-channel"></div>
                  <div class="skeleton skeleton-related-meta"></div>
                </div>
              </div>
              <div class="skeleton-related-item">
                <div class="skeleton skeleton-related-thumb"></div>
                <div class="skeleton-related-info">
                  <div class="skeleton skeleton-related-video-title"></div>
                  <div class="skeleton skeleton-related-video-title-2"></div>
                  <div class="skeleton skeleton-related-channel"></div>
                  <div class="skeleton skeleton-related-meta"></div>
                </div>
              </div>
              <div class="skeleton-related-item">
                <div class="skeleton skeleton-related-thumb"></div>
                <div class="skeleton-related-info">
                  <div class="skeleton skeleton-related-video-title"></div>
                  <div class="skeleton skeleton-related-video-title-2"></div>
                  <div class="skeleton skeleton-related-channel"></div>
                  <div class="skeleton skeleton-related-meta"></div>
                </div>
              </div>
              <div class="skeleton-related-item">
                <div class="skeleton skeleton-related-thumb"></div>
                <div class="skeleton-related-info">
                  <div class="skeleton skeleton-related-video-title"></div>
                  <div class="skeleton skeleton-related-video-title-2"></div>
                  <div class="skeleton skeleton-related-channel"></div>
                  <div class="skeleton skeleton-related-meta"></div>
                </div>
              </div>
              <div class="skeleton-related-item">
                <div class="skeleton skeleton-related-thumb"></div>
                <div class="skeleton-related-info">
                  <div class="skeleton skeleton-related-video-title"></div>
                  <div class="skeleton skeleton-related-video-title-2"></div>
                  <div class="skeleton skeleton-related-channel"></div>
                  <div class="skeleton skeleton-related-meta"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Content -->
    <div id="content" class="hidden">
      <div class="watch-container">
        <!-- Player Section -->
        <div class="player-section">
          <div class="video-player-container" id="player-container">
            <!-- Placeholder -->
            <div class="player-placeholder" id="player-placeholder">
              <div class="player-placeholder-icon">🎬</div>
              <h2>Ready to watch?</h2>
              <p>Search for a video or paste a YouTube URL to get started.</p>
            </div>

            <!-- YouTube IFrame Player -->
            <div id="player"></div>

            <!-- Proxy Player (for blocked videos) -->
            <div class="proxy-player-container hidden" id="proxy-player-container">
              <video id="proxy-video" controls playsinline></video>

              <!-- Loading overlay -->
              <div class="proxy-player-overlay hidden" id="proxy-loading">
                <div class="proxy-loading-spinner"></div>
              </div>

              <!-- Proxy badge -->
              <div class="proxy-badge hidden" id="proxy-badge">
                                <span>🔓</span>
                                <span>Bypass Mode</span>
                              </div>

                              <!-- Format selector -->
                              <div class="format-selector hidden" id="format-selector">
                                <button class="format-btn" id="format-btn">
                                  <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                                  <span id="current-quality">360p</span>
                                </button>
                                <div class="format-menu" id="format-menu"></div>
                              </div>
                            </div>

                            <!-- Error overlay -->
                            <div class="player-error-overlay hidden" id="player-error-overlay">
                              <div class="player-error-icon">⚠️</div>
                              <h3 class="player-error-title" id="error-title">Video Unavailable</h3>
                              <p class="player-error-message" id="error-message">This video cannot be played.</p>
                              <button class="player-error-btn" id="error-retry-btn">Try Alternative Player</button>
                            </div>

                            <!-- Autoplay Overlay -->
                            <div class="autoplay-overlay hidden" id="autoplay-overlay">
                              <div class="autoplay-content">
                                <p class="autoplay-label">Up Next</p>
                                <div class="autoplay-next-video">
                                  <div class="autoplay-thumb"><img id="autoplay-thumb" src="" alt=""></div>
                                  <div class="autoplay-info">
                                    <h4 class="autoplay-title" id="autoplay-title"></h4>
                                    <p class="autoplay-author" id="autoplay-author"></p>
                                  </div>
                                </div>
                                <div class="autoplay-controls">
                                  <div class="countdown-ring">
                                    <svg width="60" height="60">
                                      <circle class="bg" cx="30" cy="30" r="26"></circle>
                                      <circle class="progress" id="countdown-progress" cx="30" cy="30" r="26" stroke-dasharray="163.36" stroke-dashoffset="0"></circle>
                                    </svg>
                                    <span class="countdown-number" id="countdown-number">5</span>
                                  </div>
                                  <button class="autoplay-btn play-now-btn" id="play-now-btn">Play Now</button>
                                  <button class="autoplay-btn cancel-btn" id="cancel-autoplay-btn">Cancel</button>
                                </div>
                              </div>
                            </div>
                          </div>

                          <!-- Video Info -->
                          <div class="video-info">
                            <h1 class="video-title" id="video-title">Select a video to play</h1>
                            <div class="video-stats">
                              <div class="video-meta">
                                <span id="video-views"></span>
                                <span id="video-date"></span>
                              </div>
                              <div class="video-actions">
                                <button class="action-btn" id="like-btn"><span>👍</span><span id="like-count">Like</span></button>
                                <button class="action-btn" id="dislike-btn"><span>👎</span><span>Dislike</span></button>
                                <button class="action-btn" id="share-btn"><span>↗️</span><span>Share</span></button>
                                <button class="action-btn" id="save-btn"><span>📥</span><span>Save</span></button>
                              </div>
                            </div>
                          </div>

                          <!-- Channel Info -->
                          <div class="channel-row">
                            <div class="channel-info">
                              <img class="channel-avatar" id="channel-avatar" src="" alt="Channel">
                              <div class="channel-details">
                                <h3><a id="channel-name" href="#">Channel Name</a></h3>
                                <p class="channel-subs" id="channel-subs"></p>
                              </div>
                            </div>
                            <div class="channel-buttons">
                              <button class="subscribe-btn" id="subscribe-btn">Subscribe</button>
                            </div>
                          </div>

                          <!-- Description -->
                          <div class="description-box" id="description-box">
                            <div class="description-meta" id="desc-meta"></div>
                            <p class="description-text" id="video-description"></p>
                            <div class="description-hashtags" id="description-hashtags"></div>
                            <button class="show-more-btn hidden" id="desc-toggle">Show more</button>
                          </div>

                          <!-- Mobile Comments Bar (Collapsed - shows on mobile only) -->
                          <div class="mobile-comments-bar" id="mobile-comments-bar">
                            <div class="mobile-comments-bar-header">
                              <span class="mobile-comments-bar-title">Comments <span id="mobile-comments-count"></span></span>
                              <span class="mobile-comments-bar-arrow">›</span>
                            </div>
                            <div class="mobile-comments-preview">
                              <img class="mobile-comments-preview-avatar" id="mobile-preview-avatar" src="" alt="">
                              <p class="mobile-comments-preview-text" id="mobile-preview-text">No comments yet</p>
                            </div>
                          </div>

                          <!-- Desktop Comments Section (hidden on mobile) -->
                          <div class="comments-section desktop-comments" id="comments-section">
                            <div class="comments-header">
                              <span class="comments-count" id="comments-count">Comments</span>
                              <button class="comments-sort active" id="comments-sort-top"><span>⇅</span><span>Top</span></button>
                              <button class="comments-sort" id="comments-sort-new"><span>🕐</span><span>Newest</span></button>
                            </div>
                            <div class="add-comment">
                              <div class="add-comment-avatar">Y</div>
                              <div class="add-comment-input-wrapper">
                                <input type="text" class="add-comment-input" id="add-comment-input" placeholder="Add a comment...">
                                <div class="add-comment-actions" id="add-comment-actions">
                                  <button class="comment-cancel-btn" id="comment-cancel-btn">Cancel</button>
                                  <button class="comment-submit-btn" id="comment-submit-btn">Comment</button>
                                </div>
                              </div>
                            </div>
                            <div class="comments-list" id="comments-list"></div>
                            <div class="comments-loading hidden" id="comments-loading"><div class="spinner small"></div></div>
                            <div class="comments-end hidden" id="comments-end">No more comments</div>
                          </div>
                        </div>

                        <!-- Sidebar -->
                        <div class="sidebar" id="sidebar">
                          <!-- Playlist Panel -->
                          <div class="playlist-panel hidden" id="playlist-panel">
                            <div class="playlist-header">
                              <h2 class="playlist-title" id="playlist-title"></h2>
                              <div class="playlist-info">
                                <span class="playlist-author" id="playlist-author"></span>
                                <span class="playlist-progress" id="playlist-progress"></span>
                              </div>
                              <div class="playlist-controls">
                                <button class="shuffle-btn" id="shuffle-btn" title="Shuffle">🔀</button>
                                <div class="control-item"><span>Loop</span><div class="control-toggle" id="loop-toggle"></div></div>
                                <div class="control-item"><span>Autoplay</span><div class="control-toggle active" id="autoplay-toggle"></div></div>
                              </div>
                            </div>
                            <div class="playlist-videos" id="playlist-videos"></div>
                          </div>

                          <!-- Related Videos -->
                          <div class="related-section" id="related-section">
                            <div class="related-header">
                              <h3 class="related-title">Related Videos</h3>
                            </div>
                            <div class="related-videos" id="related-videos"></div>
                            <div class="related-loading hidden" id="related-loading"><div class="spinner small"></div></div>
                            <div class="related-end hidden" id="related-end">No more videos</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Mobile Comments Modal -->
                  <div class="mobile-comments-modal" id="mobile-comments-modal">
                    <div class="mobile-comments-modal-header">
                      <span class="mobile-comments-modal-title">Comments</span>
                      <button class="mobile-comments-modal-close" id="mobile-comments-close">✕</button>
                    </div>
                    <div class="mobile-comments-modal-sort">
                      <button class="comments-sort active" id="mobile-sort-top"><span>⇅</span><span>Top</span></button>
                      <button class="comments-sort" id="mobile-sort-new"><span>🕐</span><span>Newest</span></button>
                    </div>
                    <div class="mobile-comments-modal-content" id="mobile-comments-content"></div>
                    <div class="mobile-comments-modal-add">
                      <input type="text" placeholder="Add a comment..." id="mobile-comment-input">
                    </div>
                  </div>

                  <!-- Toast -->
                  <div class="toast" id="toast"><span id="toast-message"></span></div>

                  <script src="https://www.youtube.com/iframe_api"></script>

                  <script>
                    const API_BASE = 'https://youtube-i-7qth.onrender.com/api';

                    // State
                    let player = null;
                    let playerReady = false;
                    let currentVideoId = null;
                    let currentVideoData = null;
                    let currentPlaylistId = null;
                    let playlistData = null;
                    let currentPlaylistIndex = 0;
                    let autoplayEnabled = true;
                    let loopEnabled = false;
                    let shuffleEnabled = false;
                    let shuffledOrder = [];
                    let countdownInterval = null;
                    let countdownSeconds = 5;
                    let menuOpen = false;
                    let mobileSearchOpen = false;
                    let mobileCommentsOpen = false;

                    // Comments state
                    let commentsLoading = false;
                    let commentsHasMore = true;
                    let commentsStart = 21;
                    let commentsSortBy = 'top';
                    let allComments = [];

                    // Related state
                    let relatedLoading = false;
                    let relatedHasMore = true;
                    let relatedStart = 1;
                    let relatedEnd = 20;

                    // Proxy Player State
                    const EMBED_PROXY_API = 'https://youtube-i-7qth.onrender.com/api/embedproxy';
                    let isUsingProxyPlayer = false;
                    let proxyFormats = [];
                    let currentProxyFormat = null;
                    let embedCheckTimeout = null;
                    let proxyPlayerReady = false;

                    // ==================== SKELETON LOADING FUNCTIONS ====================
                    function showSkeleton() {
                      document.getElementById('skeleton-loading').classList.remove('hidden');
                      document.getElementById('content').classList.add('hidden');
                    }

                    function hideSkeleton() {
                      document.getElementById('skeleton-loading').classList.add('hidden');
                      document.getElementById('content').classList.remove('hidden');
                    }

                    // ==================== WATCH HISTORY CACHE ====================
                    const WATCH_HISTORY_KEY = 'youtube_watch_history';
                    const MAX_HISTORY_SIZE = 50;

                    function getWatchHistory() {
                      try {
                        const history = localStorage.getItem(WATCH_HISTORY_KEY);
                        return history ? JSON.parse(history) : [];
                      } catch (e) {
                        console.error('Error reading watch history:', e);
                        return [];
                      }
                    }

                    function addToWatchHistory(videoId) {
                      if (!videoId) return;

                      try {
                        let history = getWatchHistory();
                        history = history.filter(id => id !== videoId);
                        history.unshift(videoId);
                        if (history.length > MAX_HISTORY_SIZE) {
                          history = history.slice(0, MAX_HISTORY_SIZE);
                        }
                        localStorage.setItem(WATCH_HISTORY_KEY, JSON.stringify(history));
                        console.log('Added to watch history:', videoId);
                      } catch (e) {
                        console.error('Error saving to watch history:', e);
                      }
                    }

                    function clearWatchHistory() {
                      try {
                        localStorage.removeItem(WATCH_HISTORY_KEY);
                        console.log('Watch history cleared');
                      } catch (e) {
                        console.error('Error clearing watch history:', e);
                      }
                    }

                    // DOM Elements
                    const menuToggle = document.getElementById('menu-toggle');
                    const leftMenu = document.getElementById('left-menu');
                    const menuOverlay = document.getElementById('menu-overlay');
                    const mobileSearchBtn = document.getElementById('mobile-search-btn');
                    const mobileSearchContainer = document.getElementById('mobile-search-container');
                    const mobileSearchClose = document.getElementById('mobile-search-close');
                    const desktopSearchForm = document.getElementById('desktop-search-form');
                    const desktopSearchInput = document.getElementById('desktop-search-input');
                    const mobileSearchForm = document.getElementById('mobile-search-form');
                    const mobileSearchInput = document.getElementById('mobile-search-input');
                    const mobileCommentsBar = document.getElementById('mobile-comments-bar');
                    const mobileCommentsModal = document.getElementById('mobile-comments-modal');
                    const mobileCommentsClose = document.getElementById('mobile-comments-close');
                    const mobileCommentsContent = document.getElementById('mobile-comments-content');

                    // Proxy Player DOM
                    const proxyPlayerContainer = document.getElementById('proxy-player-container');
                    const proxyVideo = document.getElementById('proxy-video');
                    const proxyLoading = document.getElementById('proxy-loading');
                    const proxyBadge = document.getElementById('proxy-badge');
                    const formatSelector = document.getElementById('format-selector');
                    const formatBtn = document.getElementById('format-btn');
                    const formatMenu = document.getElementById('format-menu');
                    const playerErrorOverlay = document.getElementById('player-error-overlay');
                    const errorRetryBtn = document.getElementById('error-retry-btn');

                    // ==================== PROXY PLAYER FUNCTIONS ====================

                    function setupEmbedErrorDetection() {
                      if (embedCheckTimeout) {
                        clearTimeout(embedCheckTimeout);
                      }

                      embedCheckTimeout = setTimeout(() => {
                        if (player && currentVideoId) {
                          try {
                            const state = player.getPlayerState();
                          } catch (e) {
                            console.log('Player state check failed, might be blocked');
                            tryProxyPlayer(currentVideoId);
                          }
                        }
                      }, 5000);
                    }

                    function handleYouTubeError(event) {
                      const errorCode = event.data;
                      console.log('YouTube Error Code:', errorCode);

                      if (errorCode === 101 || errorCode === 150 || errorCode === 5) {
                        console.log('Embed blocked, switching to proxy player...');
                        showToast('Video embed blocked. Switching to alternative player...');
                        tryProxyPlayer(currentVideoId);
                      } else if (errorCode === 100 || errorCode === 2) {
                        showPlayerError('Video Not Found', 'This video may have been removed or is not available.');
                      }
                    }

                    async function tryProxyPlayer(videoId) {
                      if (!videoId) return;

                      console.log('Attempting proxy player for:', videoId);

                      hideYouTubePlayer();
                      showProxyLoading();

                      try {
                        const response = await fetch(`${EMBED_PROXY_API}/info/${videoId}`);
                        const data = await response.json();

                        if (!data || data.error) {
                          throw new Error(data?.error || 'Failed to fetch video info');
                        }

                        if (!data.formats || data.formats.length === 0) {
                          throw new Error('No playable formats found');
                        }

                        proxyFormats = data.formats;

                        let bestFormat = proxyFormats.find(f => f.format_id === '18');

                        if (!bestFormat) {
                          bestFormat = proxyFormats.find(f => f.hasVideo && f.hasAudio);
                        }

                        if (!bestFormat) {
                          bestFormat = proxyFormats
                            .filter(f => f.hasVideo)
                            .sort((a, b) => (b.height || 0) - (a.height || 0))[0];
                        }

                        if (!bestFormat) {
                          throw new Error('No suitable format found');
                        }

                        buildFormatMenu(proxyFormats);
                        playProxyFormat(bestFormat);

                        isUsingProxyPlayer = true;
                        showToast('Playing via alternative player');

                      } catch (error) {
                        console.error('Proxy player error:', error);
                        hideProxyLoading();
                        showPlayerError('Playback Error', error.message || 'Could not load video. Please try again later.');
                      }
                    }

                    function playProxyFormat(format) {
                      if (!format || !format.directUrl) {
                        console.error('Invalid format:', format);
                        return;
                      }

                      currentProxyFormat = format;
                      proxyLoading.classList.remove('hidden');

                      const qualityText = format.height ? `${format.height}p` : 
                                          format.abr ? `${Math.round(format.abr)}kbps` : 'Auto';
                      document.getElementById('current-quality').textContent = qualityText;

                      document.querySelectorAll('.format-menu-item').forEach(item => {
                        item.classList.toggle('active', item.dataset.formatId === format.format_id);
                      });

                      const currentTime = proxyVideo.currentTime || 0;
                      const wasPlaying = !proxyVideo.paused;

                      proxyVideo.src = format.directUrl;
                      proxyVideo.load();

                      proxyVideo.onloadedmetadata = () => {
                        if (currentTime > 0) {
                          proxyVideo.currentTime = currentTime;
                        }
                        proxyLoading.classList.add('hidden');
                        if (wasPlaying || currentTime === 0) {
                          proxyVideo.play().catch(e => console.log('Autoplay prevented'));
                        }
                      };

                      proxyVideo.onerror = () => {
                        proxyLoading.classList.add('hidden');
                        showToast('Error playing this format. Try another quality.');
                      };

                      proxyPlayerContainer.classList.remove('hidden');
                      proxyBadge.classList.remove('hidden');
                      formatSelector.classList.remove('hidden');
                      playerErrorOverlay.classList.add('hidden');

                      console.log('Playing format:', format.format_id, qualityText);
                    }

                    function buildFormatMenu(formats) {
                      formatMenu.innerHTML = '';

                      const combined = formats.filter(f => f.hasVideo && f.hasAudio)
                        .sort((a, b) => (b.height || 0) - (a.height || 0));
                      const videoOnly = formats.filter(f => f.hasVideo && !f.hasAudio)
                        .sort((a, b) => (b.height || 0) - (a.height || 0));
                      const audioOnly = formats.filter(f => !f.hasVideo && f.hasAudio)
                        .sort((a, b) => (b.abr || 0) - (a.abr || 0));

                      if (combined.length > 0) {
                        const header = document.createElement('div');
                        header.className = 'format-group-title';
                        header.textContent = '🎬 Video + Audio';
                        formatMenu.appendChild(header);

                        combined.forEach(f => {
                          formatMenu.appendChild(createFormatMenuItem(f));
                        });
                      }

                      if (videoOnly.length > 0) {
                        const header = document.createElement('div');
                        header.className = 'format-group-title';
                        header.textContent = '📹 Video Only';
                        formatMenu.appendChild(header);

                        videoOnly.slice(0, 5).forEach(f => {
                          formatMenu.appendChild(createFormatMenuItem(f));
                        });
                      }

                      if (audioOnly.length > 0) {
                        const header = document.createElement('div');
                        header.className = 'format-group-title';
                        header.textContent = '🔊 Audio Only';
                        formatMenu.appendChild(header);

                        audioOnly.slice(0, 3).forEach(f => {
                          formatMenu.appendChild(createFormatMenuItem(f));
                        });
                      }
                    }

                    function createFormatMenuItem(format) {
                      const item = document.createElement('div');
                      item.className = 'format-menu-item';
                      item.dataset.formatId = format.format_id;

                      let qualityLabel = '';
                      let infoLabel = '';

                      if (format.hasVideo && format.height) {
                        qualityLabel = `${format.height}p`;
                        infoLabel = format.ext.toUpperCase();
                        if (format.hasAudio) {
                          infoLabel += ' + Audio';
                        }
                      } else if (format.hasAudio && format.abr) {
                        qualityLabel = `${Math.round(format.abr)} kbps`;
                        infoLabel = format.ext.toUpperCase();
                      } else {
                        qualityLabel = format.format_id;
                        infoLabel = format.ext?.toUpperCase() || '';
                      }

                      if (format.filesize) {
                        const sizeMB = (format.filesize / (1024 * 1024)).toFixed(1);
                        infoLabel += ` • ${sizeMB} MB`;
                      }

                      item.innerHTML = `
                        <span class="quality">${qualityLabel}</span>
                        <span class="info">${infoLabel}</span>
                      `;

                      item.onclick = () => {
                        playProxyFormat(format);
                        formatMenu.classList.remove('open');
                      };

                      return item;
                    }

                    function toggleFormatMenu() {
                      formatMenu.classList.toggle('open');
                    }

                    function hideYouTubePlayer() {
                      const ytPlayer = document.getElementById('player');
                      if (ytPlayer) {
                        ytPlayer.style.display = 'none';
                      }
                      if (player) {
                        try {
                          player.pauseVideo();
                        } catch (e) {}
                      }
                    }

                    function showYouTubePlayer() {
                      const ytPlayer = document.getElementById('player');
                      if (ytPlayer) {
                        ytPlayer.style.display = 'block';
                      }
                      proxyPlayerContainer.classList.add('hidden');
                      proxyBadge.classList.add('hidden');
                      formatSelector.classList.add('hidden');
                      isUsingProxyPlayer = false;
                    }

                    function showProxyLoading() {
                      proxyPlayerContainer.classList.remove('hidden');
                      proxyLoading.classList.remove('hidden');
                      playerErrorOverlay.classList.add('hidden');
                    }

                    function hideProxyLoading() {
                      proxyLoading.classList.add('hidden');
                    }

                    function showPlayerError(title, message) {
                      document.getElementById('error-title').textContent = title;
                      document.getElementById('error-message').textContent = message;
                      playerErrorOverlay.classList.remove('hidden');
                      proxyPlayerContainer.classList.remove('hidden');
                      proxyLoading.classList.add('hidden');
                    }

                    function resetPlayer() {
                      if (proxyVideo) {
                        proxyVideo.pause();
                        proxyVideo.src = '';
                      }
                      proxyPlayerContainer.classList.add('hidden');
                      proxyBadge.classList.add('hidden');
                      formatSelector.classList.add('hidden');
                      proxyLoading.classList.add('hidden');
                      playerErrorOverlay.classList.add('hidden');
                      formatMenu.classList.remove('open');

                      isUsingProxyPlayer = false;
                      proxyFormats = [];
                      currentProxyFormat = null;

                      showYouTubePlayer();
                    }

                    function handleProxyVideoEnded() {
                      if (!autoplayEnabled) return;

                      if (playlistData) {
                        const nextIndex = getNextVideoIndex();
                        if (nextIndex !== null) {
                          startAutoplayCountdown(nextIndex);
                          return;
                        }
                      }

                      const firstRelated = document.querySelector('.related-video-item');
                      if (firstRelated) {
                        const videoId = firstRelated.href.split('v=')[1]?.split('&')[0];
                        if (videoId) startAutoplayCountdownRelated(videoId, firstRelated);
                      }
                    }

                    // Menu
                    function toggleMenu() {
                      menuOpen = !menuOpen;
                      leftMenu.classList.toggle('open', menuOpen);
                      menuOverlay.classList.toggle('open', menuOpen);
                    }
                    menuToggle.addEventListener('click', toggleMenu);
                    menuOverlay.addEventListener('click', toggleMenu);

                    // Mobile search
                    function openMobileSearch() {
                      mobileSearchOpen = true;
                      mobileSearchContainer.classList.add('open');
                      mobileSearchInput.focus();
                    }
                    function closeMobileSearch() {
                      mobileSearchOpen = false;
                      mobileSearchContainer.classList.remove('open');
                    }
                    mobileSearchBtn.addEventListener('click', openMobileSearch);
                    mobileSearchClose.addEventListener('click', closeMobileSearch);

                    // Mobile comments modal
                    function openMobileComments() {
                      mobileCommentsOpen = true;
                      mobileCommentsModal.classList.add('open');
                      document.body.style.overflow = 'hidden';
                      renderMobileComments();
                    }

                    function closeMobileComments() {
                      mobileCommentsOpen = false;
                      mobileCommentsModal.classList.remove('open');
                      document.body.style.overflow = '';
                    }

                    mobileCommentsBar.addEventListener('click', openMobileComments);
                    mobileCommentsClose.addEventListener('click', closeMobileComments);

                    function renderMobileComments() {
                      mobileCommentsContent.innerHTML = '';
                      allComments.forEach(comment => {
                        const item = createCommentElement(comment);
                        mobileCommentsContent.appendChild(item);
                      });
                    }

                    mobileCommentsContent.addEventListener('scroll', () => {
                      if (!currentVideoId || commentsLoading || !commentsHasMore) return;

                      const { scrollTop, scrollHeight, clientHeight } = mobileCommentsContent;
                      if (scrollTop + clientHeight >= scrollHeight - 200) {
                        loadMoreComments(true);
                      }
                    });

                    document.getElementById('mobile-sort-top').addEventListener('click', function() {
                      if (commentsSortBy !== 'top') {
                        commentsSortBy = 'top';
                        this.classList.add('active');
                        document.getElementById('mobile-sort-new').classList.remove('active');
                        reloadComments();
                      }
                    });

                    document.getElementById('mobile-sort-new').addEventListener('click', function() {
                      if (commentsSortBy !== 'newest') {
                        commentsSortBy = 'newest';
                        this.classList.add('active');
                        document.getElementById('mobile-sort-top').classList.remove('active');
                        reloadComments();
                      }
                    });

                    // Search
                    function performSearch(query) {
                      if (query && query.trim()) {
                        const videoId = extractVideoId(query);
                        const playlistId = extractPlaylistId(query);

                        if (playlistId) {
                          if (videoId && !query.includes('playlist?')) loadVideo(videoId);
                          loadPlaylist(playlistId, 0, !videoId);
                        } else if (videoId) {
                          loadVideo(videoId);
                        } else {
                          window.location.href = `/search?q=${encodeURIComponent(query.trim())}`;
                        }
                      }
                    }

                    desktopSearchForm.addEventListener('submit', (e) => { e.preventDefault(); performSearch(desktopSearchInput.value); });
                    mobileSearchForm.addEventListener('submit', (e) => { e.preventDefault(); performSearch(mobileSearchInput.value); closeMobileSearch(); });

                    window.addEventListener('resize', () => {
                      if (window.innerWidth > 768) {
                        if (menuOpen) toggleMenu();
                        if (mobileSearchOpen) closeMobileSearch();
                        if (mobileCommentsOpen) closeMobileComments();
                      }
                    });

                    // Helpers
                    function getUrlParams() {
                      const params = new URLSearchParams(window.location.search);
                      return { videoId: params.get('v'), playlistId: params.get('list'), index: parseInt(params.get('index')) || 0 };
                    }

                    function updateURL(videoId, playlistId = null, index = null) {
                      let url = `/watch?v=${videoId}`;
                      if (playlistId) { url += `&list=${playlistId}`; if (index > 0) url += `&index=${index}`; }
                      window.history.pushState({}, '', url);
                    }

                    function fixThumbnailUrl(url) {
                      if (!url) return 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 9"><rect fill="%23333" width="16" height="9"/></svg>';
                      return url.startsWith('//') ? 'https:' + url : url;
                    }

                    function escapeHtml(text) {
                      if (!text) return '';
                      const div = document.createElement('div');
                      div.textContent = text;
                      return div.innerHTML;
                    }

                    function formatNumber(num) {
                      if (!num) return '0';
                      if (typeof num === 'string') num = parseInt(num.replace(/[^0-9]/g, ''));
                      if (isNaN(num)) return '0';
                      if (num >= 1e9) return (num / 1e9).toFixed(1).replace(/\.0$/, '') + 'B';
                      if (num >= 1e6) return (num / 1e6).toFixed(1).replace(/\.0$/, '') + 'M';
                      if (num >= 1e3) return (num / 1e3).toFixed(1).replace(/\.0$/, '') + 'K';
                      return num.toString();
                    }

                    function showToast(msg) {
                      const toast = document.getElementById('toast');
                      document.getElementById('toast-message').textContent = msg;
                      toast.classList.add('show');
                      setTimeout(() => toast.classList.remove('show'), 4000);
                    }

                    function extractPlaylistId(input) {
                      if (!input) return null;
                      input = input.trim();
                      if (/^PL[A-Za-z0-9_-]{10,}$/.test(input)) return input;
                      const match = input.match(/[?&]list=([A-Za-z0-9_-]+)/);
                      return match ? match[1] : null;
                    }

                    function extractVideoId(input) {
                      if (!input) return null;
                      input = input.trim();
                      if (/^[A-Za-z0-9_-]{11}$/.test(input)) return input;
                      const patterns = [/[?&]v=([A-Za-z0-9_-]{11})/, /youtu\.be\/([A-Za-z0-9_-]{11})/, /embed\/([A-Za-z0-9_-]{11})/, /shorts\/([A-Za-z0-9_-]{11})/];
                      for (const p of patterns) { const m = input.match(p); if (m) return m[1]; }
                      return null;
                    }

                    // YouTube Player
                    function onYouTubeIframeAPIReady() {
                      playerReady = true;
                      const params = getUrlParams();

                      if (params.videoId) {
                        showSkeleton();
                        loadVideo(params.videoId);
                        if (params.playlistId) loadPlaylist(params.playlistId, params.index);
                      } else if (params.playlistId) {
                        showSkeleton();
                        loadPlaylist(params.playlistId, 0, true);
                      } else {
                        hideSkeleton();
                      }
                    }

                    function initPlayer(videoId) {
                      document.getElementById('player-placeholder').classList.add('hidden');
                      resetPlayer();

                      if (player) {
                        player.loadVideoById(videoId);
                        setupEmbedErrorDetection();
                        return;
                      }

                      player = new YT.Player('player', {
                        height: '100%',
                        width: '100%',
                        videoId,
                        playerVars: {
                          autoplay: 1,
                          rel: 0,
                          modestbranding: 1,
                          playsinline: 1,
                          enablejsapi: 1
                        },
                        events: {
                          onReady: (e) => {
                            e.target.playVideo();
                            setupEmbedErrorDetection();
                          },
                          onStateChange: (e) => {
                            if (e.data === YT.PlayerState.ENDED) handleVideoEnded();
                            if (e.data === YT.PlayerState.PLAYING) {
                              cancelAutoplayCountdown();
                              if (embedCheckTimeout) {
                                clearTimeout(embedCheckTimeout);
                              }
                            }
                          },
                          onError: handleYouTubeError
                        }
                      });
                    }

                    // Load video
                    async function loadVideo(videoId) {
                      currentVideoId = videoId;
                      updateURL(videoId, currentPlaylistId);

                      showSkeleton();

                      addToWatchHistory(videoId);

                      resetPlayer();

                      initPlayer(videoId);

                      commentsStart = 21;
                      commentsHasMore = true;
                      allComments = [];
                      relatedStart = 1;
                      relatedEnd = 20;
                      relatedHasMore = true;

                      document.getElementById('comments-list').innerHTML = '';
                      document.getElementById('related-videos').innerHTML = '';
                      document.getElementById('comments-end').classList.add('hidden');
                      document.getElementById('related-end').classList.add('hidden');

                      try {
                        const response = await fetch(`${API_BASE}/search/video/${videoId}`);
                        const data = await response.json();

                        if (data.success && data.video) {
                          currentVideoData = data.video;
                          updateVideoUI(data.video);

                          if (data.video.comments?.items) {
                            allComments = data.video.comments.items;
                            renderComments(allComments);
                            updateMobileCommentsPreview();
                            commentsHasMore = data.video.comments.hasMore;
                          }

                          loadRelatedVideos(videoId, true);
                        }

                        hideSkeleton();

                      } catch (error) {
                        console.error('Error:', error);
                        loadVideoOembed(videoId);
                        loadRelatedVideos(videoId, true);
                        hideSkeleton();
                      }
                    }

                    async function loadVideoOembed(videoId) {
                      try {
                        const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`);
                        const data = await response.json();
                        document.getElementById('video-title').textContent = data.title || 'Video';
                        document.getElementById('channel-name').textContent = data.author_name || 'Channel';
                        document.getElementById('channel-name').href = `/${data.author_name}` || '#';
                        document.getElementById('channel-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(data.author_name || 'C')}`;
                        document.title = `${data.title} - YouTube`;
                      } catch (e) { console.error(e); }
                    }

                    function updateVideoUI(video) {
                      document.getElementById('video-title').textContent = video.title || 'Video';
                      document.title = `${video.title} - YouTube`;
                      document.getElementById('video-views').textContent = video.viewsFormatted ? `${video.viewsFormatted} views` : '';
                      document.getElementById('like-count').textContent = video.likesFormatted || 'Like';

                      if (video.channel) {
                        document.getElementById('channel-name').textContent = video.channel.name || 'Channel';
                        document.getElementById('channel-name').href = video.channel.url || '#';
                        document.getElementById('channel-subs').textContent = video.channel.subscriberCount || '';
                        document.getElementById('channel-avatar').src = video.channel.thumbnail || 'C';
                      }

                      document.getElementById('desc-meta').textContent = `${video.viewsFormatted || ''} views`;
                      document.getElementById('video-description').textContent = video.description || '';

                      const hashtagsContainer = document.getElementById('description-hashtags');
                      hashtagsContainer.innerHTML = '';
                      if (video.metadata?.hashtags?.length) {
                        video.metadata.hashtags.forEach(tag => {
                          const a = document.createElement('a');
                          a.className = 'hashtag';
                          a.href = `/search?q=${encodeURIComponent(tag)}`;
                          a.textContent = tag;
                          hashtagsContainer.appendChild(a);
                        });
                      }

                      if (video.description?.length > 200) document.getElementById('desc-toggle').classList.remove('hidden');
                    }

                    function updateMobileCommentsPreview() {
                      if (allComments.length > 0) {
                        const first = allComments[0];
                        document.getElementById('mobile-preview-avatar').src = fixThumbnailUrl(first.author?.thumbnail);
                        document.getElementById('mobile-preview-text').textContent = first.text || '';
                        document.getElementById('mobile-comments-count').textContent = `(${allComments.length}+)`;
                      }
                    }

                    // Comments
                    function createCommentElement(comment) {
                      const item = document.createElement('div');
                      item.className = 'comment-item';

                      let badges = '';
                      if (comment.isPinned) badges += '<span class="comment-badge pinned">📌 Pinned</span>';
                      if (comment.isHearted) badges += '<span class="comment-badge hearted">❤️</span>';

                      const authorClass = comment.author?.isChannelOwner ? 'comment-author owner' : 
                                         (comment.author?.isVerified ? 'comment-author verified' : 'comment-author');

                      item.innerHTML = `
                        <img class="comment-avatar" src="${fixThumbnailUrl(comment.author?.thumbnail)}" alt="" loading="lazy">
                        <div class="comment-content">
                          <div class="comment-header">
                            <a class="${authorClass}" href="/${comment.author?.id || '#'}">${escapeHtml(comment.author?.name || 'User')}</a>
                            <span class="comment-time">${comment.published || ''}</span>
                            ${badges ? `<div class="comment-badges">${badges}</div>` : ''}
                          </div>
                          <p class="comment-text ${comment.text?.length > 300 ? 'collapsed' : ''}">${escapeHtml(comment.text || '')}</p>
                          ${comment.text?.length > 300 ? '<button class="comment-read-more">Read more</button>' : ''}
                          <div class="comment-actions">
                            <button class="comment-action-btn"><span>👍</span><span>${comment.likes || ''}</span></button>
                            <button class="comment-action-btn"><span>👎</span></button>
                            <button class="comment-reply-btn">Reply</button>
                          </div>
                          ${comment.replyCount && parseInt(comment.replyCount) > 0 ? `
                            <button class="comment-replies-toggle"><span>▼</span><span>${comment.replyCount} replies</span></button>
                          ` : ''}
                        </div>
                      `;

                      const readMoreBtn = item.querySelector('.comment-read-more');
                      if (readMoreBtn) {
                        readMoreBtn.addEventListener('click', () => {
                          const text = item.querySelector('.comment-text');
                          text.classList.toggle('collapsed');
                          readMoreBtn.textContent = text.classList.contains('collapsed') ? 'Read more' : 'Show less';
                        });
                      }

                      return item;
                    }

                    function renderComments(comments, append = false) {
                      const container = document.getElementById('comments-list');
                      if (!append) container.innerHTML = '';

                      comments.forEach(comment => {
                        container.appendChild(createCommentElement(comment));
                      });

                      const count = container.querySelectorAll('.comment-item').length;
                      document.getElementById('comments-count').textContent = `${count} Comments`;
                    }

                    async function loadMoreComments(forMobile = false) {
                      if (commentsLoading || !commentsHasMore || !currentVideoId) return;

                      commentsLoading = true;
                      if (!forMobile) document.getElementById('comments-loading').classList.remove('hidden');

                      try {
                        const end = commentsStart + 9;
                        const response = await fetch(`${API_BASE}/search/video/${currentVideoId}/comments?start=${commentsStart}&end=${end}&sort=${commentsSortBy}`);
                        const data = await response.json();

                        if (data.success && data.comments?.length > 0) {
                          allComments = [...allComments, ...data.comments];

                          if (forMobile) {
                            data.comments.forEach(comment => {
                              mobileCommentsContent.appendChild(createCommentElement(comment));
                            });
                          } else {
                            renderComments(data.comments, true);
                          }

                          commentsStart = end + 1;
                          commentsHasMore = data.hasMore !== false && data.comments.length >= 10;
                        } else {
                          commentsHasMore = false;
                        }

                        if (!commentsHasMore && !forMobile) {
                          document.getElementById('comments-end').classList.remove('hidden');
                        }
                      } catch (error) {
                        console.error('Error loading comments:', error);
                        commentsHasMore = false;
                      } finally {
                        commentsLoading = false;
                        if (!forMobile) document.getElementById('comments-loading').classList.add('hidden');
                      }
                    }

                    async function reloadComments() {
                      commentsStart = 1;
                      commentsHasMore = true;
                      allComments = [];

                      document.getElementById('comments-list').innerHTML = '';
                      mobileCommentsContent.innerHTML = '';
                      document.getElementById('comments-end').classList.add('hidden');
                      document.getElementById('comments-loading').classList.remove('hidden');

                      try {
                        const response = await fetch(`${API_BASE}/search/video/${currentVideoId}/comments?start=1&end=20&sort=${commentsSortBy}`);
                        const data = await response.json();

                        if (data.success && data.comments) {
                          allComments = data.comments;
                          renderComments(allComments);
                          updateMobileCommentsPreview();

                          if (mobileCommentsOpen) renderMobileComments();

                          commentsStart = 21;
                          commentsHasMore = data.hasMore !== false;
                        }
                      } catch (error) {
                        console.error('Error:', error);
                      } finally {
                        document.getElementById('comments-loading').classList.add('hidden');
                      }
                    }

                    // Related videos
                    function renderRelatedVideos(videos, append = false) {
                      const container = document.getElementById('related-videos');
                      if (!append) container.innerHTML = '';

                      if (!videos || !Array.isArray(videos)) {
                        console.error('Invalid videos data:', videos);
                        return;
                      }

                      videos.forEach(video => {
                        if (!video || !video.id) return;
                        if (video.type && video.type !== 'video') return;
                        if (video.id === currentVideoId) return;

                        const item = document.createElement('a');
                        item.className = 'related-video-item';
                        item.href = `/watch?v=${video.id}`;

                        const verified = video.channel?.isVerified || video.channel?.isArtist;
                        const thumbnail = video.thumbnail || video.img || '';
                        const title = video.title || 'Untitled';
                        const channelName = video.channel?.name || video.author || '';
                        const duration = video.duration || video.durationFormatted || '';
                        const views = video.views || video.viewsFormatted || '';
                        const published = video.published || video.uploadDate || '';

                        item.innerHTML = `
                          <div class="related-video-thumb">
                            <img src="${fixThumbnailUrl(thumbnail)}" alt="${escapeHtml(title)}" loading="lazy" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 16 9%22><rect fill=%22%23333%22 width=%2216%22 height=%229%22/></svg>'">
                            ${duration ? `<span class="related-video-duration">${duration}</span>` : ''}
                          </div>
                          <div class="related-video-info">
                            <h4 class="related-video-title">${escapeHtml(title)}</h4>
                            <p class="related-video-channel ${verified ? 'verified' : ''}">${escapeHtml(channelName)}</p>
                            <p class="related-video-meta">${views}${views && published ? ' • ' : ''}${published}</p>
                          </div>
                        `;

                        item.addEventListener('click', (e) => {
                          e.preventDefault();
                          loadVideo(video.id);
                          window.scrollTo({ top: 0, behavior: 'smooth' });
                        });

                        container.appendChild(item);
                      });

                      if (!append && container.children.length === 0) {
                        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #aaa;">No related videos available</div>';
                      }
                    }

                    async function loadRelatedVideos(videoId, reset = false) {
                      if (relatedLoading || (!relatedHasMore && !reset)) return;

                      if (reset) {
                        relatedStart = 1;
                        relatedEnd = 20;
                        relatedHasMore = true;
                        document.getElementById('related-videos').innerHTML = '';
                        document.getElementById('related-end').classList.add('hidden');
                      }

                      relatedLoading = true;
                      document.getElementById('related-loading').classList.remove('hidden');

                      try {
                        const response = await fetch(`${API_BASE}/search/video/${videoId}/related?start=${relatedStart}&end=${relatedEnd}`);

                        if (!response.ok) {
                          throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();

                        console.log('Related videos response:', data);

                        if (data.success && data.results?.length > 0) {
                          renderRelatedVideos(data.results, !reset);
                          relatedStart = relatedEnd + 1;
                          relatedEnd = relatedStart + 19;
                          relatedHasMore = data.results.length >= 10;
                        } else if (data.results?.length > 0) {
                          renderRelatedVideos(data.results, !reset);
                          relatedStart = relatedEnd + 1;
                          relatedEnd = relatedStart + 19;
                          relatedHasMore = data.results.length >= 10;
                        } else {
                          relatedHasMore = false;
                          console.log('No related videos found');
                        }

                        if (!relatedHasMore) document.getElementById('related-end').classList.remove('hidden');
                      } catch (error) {
                        console.error('Error loading related videos:', error);
                        relatedHasMore = false;
                        const container = document.getElementById('related-videos');
                        if (reset && container.innerHTML === '') {
                          container.innerHTML = '<div style="padding: 20px; text-align: center; color: #aaa;">Failed to load related videos</div>';
                        }
                      } finally {
                        relatedLoading = false;
                        document.getElementById('related-loading').classList.add('hidden');
                      }
                    }

                    // Playlist
                    async function loadPlaylist(playlistId, startIndex = 0, autoPlayFirst = false) {
                      currentPlaylistId = playlistId;
                      showToast('Loading playlist...');

                      try {
                        const response = await fetch(`${API_BASE}/channel/playlist/${playlistId}`);
                        const data = await response.json();

                        if (data?.videos?.length > 0) {
                          playlistData = data;
                          shuffledOrder = [...Array(data.videos.length).keys()];

                          document.getElementById('playlist-panel').classList.remove('hidden');
                          document.getElementById('playlist-title').textContent = data.title || 'Playlist';
                          document.getElementById('playlist-author').innerHTML = data.author ? 
                            `<a href="/@${data.author}">${escapeHtml(data.author)}</a>` : '';

                          renderPlaylistVideos();

                          if (currentVideoId) {
                            const idx = data.videos.findIndex(v => v.id === currentVideoId);
                            if (idx !== -1) currentPlaylistIndex = idx;
                          } else {
                            currentPlaylistIndex = startIndex;
                          }

                          updatePlaylistProgress();
                          highlightCurrentVideo();

                          if (autoPlayFirst) playVideoFromPlaylist(currentPlaylistIndex);

                          showToast(`Loaded ${data.videos.length} videos`);
                        } else {
                          showToast('Playlist not found or empty');
                        }
                      } catch (error) {
                        console.error('Error:', error);
                        showToast('Failed to load playlist');
                      }
                    }

                    function renderPlaylistVideos() {
                      const container = document.getElementById('playlist-videos');
                      container.innerHTML = '';

                      const order = shuffleEnabled ? shuffledOrder : [...Array(playlistData.videos.length).keys()];

                      order.forEach((videoIndex, displayIndex) => {
                        const video = playlistData.videos[videoIndex];
                        const item = document.createElement('div');
                        item.className = 'playlist-video-item' + (videoIndex === currentPlaylistIndex ? ' active' : '');
                        item.dataset.index = videoIndex;
                        item.onclick = () => playVideoFromPlaylist(videoIndex);

                        item.innerHTML = `
                          <div class="video-index ${videoIndex === currentPlaylistIndex ? 'playing' : ''}">${videoIndex === currentPlaylistIndex ? '▶' : displayIndex + 1}</div>
                          <div class="playlist-video-thumb">
                            <img src="${fixThumbnailUrl(video.img || video.thumbnail)}" alt="" loading="lazy">
                            ${video.duration ? `<span class="playlist-video-duration">${video.duration}</span>` : ''}
                          </div>
                          <div class="playlist-video-info">
                            <h4 class="playlist-video-title">${escapeHtml(video.title)}</h4>
                            <p class="playlist-video-author">${escapeHtml(video.author || playlistData.author || '')}</p>
                          </div>
                        `;
                        container.appendChild(item);
                      });
                    }

                    function playVideoFromPlaylist(index) {
                      if (!playlistData?.videos[index]) return;

                      cancelAutoplayCountdown();
                      const video = playlistData.videos[index];
                      currentPlaylistIndex = index;

                      loadVideo(video.id);
                      updateURL(video.id, currentPlaylistId, index);

                      updatePlaylistProgress();
                      highlightCurrentVideo();
                      scrollToCurrentVideo();
                    }

                    function updatePlaylistProgress() {
                      if (playlistData) {
                        document.getElementById('playlist-progress').textContent = `${currentPlaylistIndex + 1} / ${playlistData.videos.length}`;
                      }
                    }

                    function highlightCurrentVideo() {
                      document.querySelectorAll('.playlist-video-item').forEach(item => {
                        const idx = parseInt(item.dataset.index);
                        const isActive = idx === currentPlaylistIndex;
                        item.classList.toggle('active', isActive);

                        const indexEl = item.querySelector('.video-index');
                        indexEl.classList.toggle('playing', isActive);
                        indexEl.textContent = isActive ? '▶' : (shuffleEnabled ? shuffledOrder.indexOf(idx) + 1 : idx + 1);
                      });
                    }

                    function scrollToCurrentVideo() {
                      const activeItem = document.querySelector('.playlist-video-item.active');
                      if (activeItem) activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }

                    function handleVideoEnded() {
                      if (!autoplayEnabled) return;

                      if (playlistData) {
                        const nextIndex = getNextVideoIndex();
                        if (nextIndex !== null) {
                          startAutoplayCountdown(nextIndex, true);
                          return;
                        }
                      }

                      const firstRelated = document.querySelector('.related-video-item');
                      if (firstRelated) {
                        const videoId = firstRelated.href.split('v=')[1]?.split('&')[0];
                        if (videoId) startAutoplayCountdownRelated(videoId, firstRelated);
                      }
                    }

                    function getNextVideoIndex() {
                      if (!playlistData?.videos) return null;
                      const order = shuffleEnabled ? shuffledOrder : [...Array(playlistData.videos.length).keys()];
                      const currentOrderIndex = order.indexOf(currentPlaylistIndex);
                      const nextOrderIndex = currentOrderIndex + 1;

                      if (nextOrderIndex < order.length) return order[nextOrderIndex];
                      if (loopEnabled) return order[0];
                      return null;
                    }

                    function startAutoplayCountdown(nextIndex) {
                      const nextVideo = playlistData.videos[nextIndex];
                      if (!nextVideo) return;

                      document.getElementById('autoplay-thumb').src = fixThumbnailUrl(nextVideo.img || nextVideo.thumbnail);
                      document.getElementById('autoplay-title').textContent = nextVideo.title;
                      document.getElementById('autoplay-author').textContent = nextVideo.author || playlistData.author || '';
                      document.getElementById('autoplay-overlay').classList.remove('hidden');

                      countdownSeconds = 5;
                      updateCountdown();

                      countdownInterval = setInterval(() => {
                        countdownSeconds--;
                        updateCountdown();
                        if (countdownSeconds <= 0) {
                          cancelAutoplayCountdown();
                          playVideoFromPlaylist(nextIndex);
                        }
                      }, 1000);
                    }

                    function startAutoplayCountdownRelated(videoId, element) {
                      const title = element.querySelector('.related-video-title')?.textContent || 'Next video';
                      const author = element.querySelector('.related-video-channel')?.textContent || '';
                      const thumb = element.querySelector('img')?.src || '';

                      document.getElementById('autoplay-thumb').src = thumb;
                      document.getElementById('autoplay-title').textContent = title;
                      document.getElementById('autoplay-author').textContent = author;
                      document.getElementById('autoplay-overlay').classList.remove('hidden');

                      countdownSeconds = 5;
                      updateCountdown();

                      countdownInterval = setInterval(() => {
                        countdownSeconds--;
                        updateCountdown();
                        if (countdownSeconds <= 0) {
                          cancelAutoplayCountdown();
                          loadVideo(videoId);
                          window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                      }, 1000);
                    }

                    function updateCountdown() {
                      document.getElementById('countdown-number').textContent = countdownSeconds;
                      const progress = document.getElementById('countdown-progress');
                      const offset = 163.36 - (countdownSeconds / 5) * 163.36;
                      progress.style.strokeDashoffset = offset;
                    }

                    function cancelAutoplayCountdown() {
                      if (countdownInterval) {
                        clearInterval(countdownInterval);
                        countdownInterval = null;
                      }
                      document.getElementById('autoplay-overlay').classList.add('hidden');
                    }

                    function playNextVideo() {
                      const nextIndex = getNextVideoIndex();
                      if (nextIndex !== null) playVideoFromPlaylist(nextIndex);
                    }

                    function shufflePlaylist() {
                      if (!playlistData) return;

                      shuffleEnabled = !shuffleEnabled;
                      document.getElementById('shuffle-btn').classList.toggle('active', shuffleEnabled);

                      if (shuffleEnabled) {
                        shuffledOrder = [...Array(playlistData.videos.length).keys()];
                        for (let i = shuffledOrder.length - 1; i > 0; i--) {
                          const j = Math.floor(Math.random() * (i + 1));
                          [shuffledOrder[i], shuffledOrder[j]] = [shuffledOrder[j], shuffledOrder[i]];
                        }
                        const currentIdx = shuffledOrder.indexOf(currentPlaylistIndex);
                        if (currentIdx > 0) {
                          shuffledOrder.splice(currentIdx, 1);
                          shuffledOrder.unshift(currentPlaylistIndex);
                        }
                        showToast('Shuffle enabled');
                      } else {
                        shuffledOrder = [...Array(playlistData.videos.length).keys()];
                        showToast('Shuffle disabled');
                      }

                      renderPlaylistVideos();
                      highlightCurrentVideo();
                    }

                    // Scroll handlers
                    function setupScrollHandlers() {
                      window.addEventListener('scroll', () => {
                        if (!currentVideoId || window.innerWidth <= 768) return;

                        const commentsSection = document.getElementById('comments-section');
                        if (commentsSection) {
                          const rect = commentsSection.getBoundingClientRect();
                          if (rect.bottom <= window.innerHeight + 500 && commentsHasMore && !commentsLoading) {
                            loadMoreComments(false);
                          }
                        }
                      });

                      const relatedVideos = document.getElementById('related-videos');
                      if (relatedVideos) {
                        relatedVideos.addEventListener('scroll', () => {
                          if (!currentVideoId || window.innerWidth <= 1000) return;

                          const { scrollTop, scrollHeight, clientHeight } = relatedVideos;
                          if (scrollTop + clientHeight >= scrollHeight - 200 && relatedHasMore && !relatedLoading) {
                            loadRelatedVideos(currentVideoId, false);
                          }
                        });
                      }

                      window.addEventListener('scroll', () => {
                        if (!currentVideoId || window.innerWidth > 1000) return;

                        const relatedSection = document.getElementById('related-section');
                        if (relatedSection) {
                          const rect = relatedSection.getBoundingClientRect();
                          if (rect.bottom <= window.innerHeight + 300 && relatedHasMore && !relatedLoading) {
                            loadRelatedVideos(currentVideoId, false);
                          }
                        }
                      });
                    }

                    // Event listeners
                    function setupEventListeners() {
                      document.getElementById('shuffle-btn').onclick = shufflePlaylist;

                      document.getElementById('loop-toggle').onclick = function() {
                        loopEnabled = !loopEnabled;
                        this.classList.toggle('active', loopEnabled);
                        showToast(loopEnabled ? 'Loop enabled' : 'Loop disabled');
                      };

                      document.getElementById('autoplay-toggle').onclick = function() {
                        autoplayEnabled = !autoplayEnabled;
                        this.classList.toggle('active', autoplayEnabled);
                        showToast(autoplayEnabled ? 'Autoplay enabled' : 'Autoplay disabled');
                      };

                      document.getElementById('play-now-btn').onclick = () => {
                        cancelAutoplayCountdown();
                        if (playlistData) {
                          const nextIndex = getNextVideoIndex();
                          if (nextIndex !== null) playVideoFromPlaylist(nextIndex);
                        } else {
                          const firstRelated = document.querySelector('.related-video-item');
                          if (firstRelated) {
                            const videoId = firstRelated.href.split('v=')[1]?.split('&')[0];
                            if (videoId) { loadVideo(videoId); window.scrollTo({ top: 0, behavior: 'smooth' }); }
                          }
                        }
                      };

                      document.getElementById('cancel-autoplay-btn').onclick = cancelAutoplayCountdown;

                      // Description
                      document.getElementById('description-box').onclick = function(e) {
                        if (e.target.classList.contains('hashtag') || e.target.id === 'desc-toggle') return;
                        if (!this.classList.contains('expanded')) {
                          document.getElementById('video-description').classList.add('expanded');
                          this.classList.add('expanded');
                          document.getElementById('desc-toggle').textContent = 'Show less';
                          document.getElementById('desc-toggle').classList.remove('hidden');
                        }
                      };

                      document.getElementById('desc-toggle').onclick = function(e) {
                        e.stopPropagation();
                        const desc = document.getElementById('video-description');
                        const box = document.getElementById('description-box');
                        desc.classList.toggle('expanded');
                        box.classList.toggle('expanded');
                        this.textContent = desc.classList.contains('expanded') ? 'Show less' : 'Show more';
                      };

                      // Actions
                      document.getElementById('like-btn').onclick = function() {
                        this.classList.toggle('liked');
                        showToast(this.classList.contains('liked') ? 'Added to liked videos' : 'Removed from liked videos');
                      };

                      document.getElementById('subscribe-btn').onclick = function() {
                        this.classList.toggle('subscribed');
                        this.textContent = this.classList.contains('subscribed') ? 'Subscribed' : 'Subscribe';
                        showToast(this.classList.contains('subscribed') ? 'Subscribed!' : 'Unsubscribed');
                      };

                      document.getElementById('share-btn').onclick = () => {
                        navigator.clipboard.writeText(window.location.href)
                          .then(() => showToast('Link copied to clipboard'))
                          .catch(() => showToast('Failed to copy link'));
                      };

                      // Desktop comment input
                      const commentInput = document.getElementById('add-comment-input');
                      const commentActions = document.getElementById('add-comment-actions');
                      const commentSubmit = document.getElementById('comment-submit-btn');

                      commentInput.addEventListener('focus', () => commentActions.classList.add('show'));
                      commentInput.addEventListener('input', () => commentSubmit.classList.toggle('active', commentInput.value.trim().length > 0));

                      document.getElementById('comment-cancel-btn').onclick = () => {
                        commentInput.value = '';
                        commentInput.blur();
                        commentActions.classList.remove('show');
                        commentSubmit.classList.remove('active');
                      };

                      document.getElementById('comment-submit-btn').onclick = () => {
                        if (commentInput.value.trim()) {
                          showToast('Comments are view-only');
                          commentInput.value = '';
                          commentActions.classList.remove('show');
                        }
                      };

                      // Desktop sort
                      document.getElementById('comments-sort-top').onclick = function() {
                        if (commentsSortBy !== 'top') {
                          commentsSortBy = 'top';
                          this.classList.add('active');
                          document.getElementById('comments-sort-new').classList.remove('active');
                          reloadComments();
                        }
                      };

                      document.getElementById('comments-sort-new').onclick = function() {
                        if (commentsSortBy !== 'newest') {
                          commentsSortBy = 'newest';
                          this.classList.add('active');
                          document.getElementById('comments-sort-top').classList.remove('active');
                          reloadComments();
                        }
                      };

                      // Keyboard
                      document.addEventListener('keydown', (e) => {
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                        switch(e.key) {
                          case 'Escape':
                            if (mobileSearchOpen) closeMobileSearch();
                            if (mobileCommentsOpen) closeMobileComments();
                            cancelAutoplayCountdown();
                            break;
                          case 'n': case 'N':
                            if (e.shiftKey && playlistData) playNextVideo();
                            break;
                          case 'p': case 'P':
                            if (e.shiftKey && playlistData && currentPlaylistIndex > 0) playVideoFromPlaylist(currentPlaylistIndex - 1);
                            break;
                          case 's': case 'S':
                            if (e.shiftKey) shufflePlaylist();
                            break;
                          case 'l': case 'L':
                            if (e.shiftKey) {
                              loopEnabled = !loopEnabled;
                              document.getElementById('loop-toggle').classList.toggle('active', loopEnabled);
                              showToast(loopEnabled ? 'Loop enabled' : 'Loop disabled');
                            }
                            break;
                          case 'b': case 'B':
                            if (!isUsingProxyPlayer && currentVideoId) {
                              showToast('Switching to bypass player...');
                              tryProxyPlayer(currentVideoId);
                            } else if (isUsingProxyPlayer) {
                              showToast('Switching back to YouTube player...');
                              resetPlayer();
                              if (player && currentVideoId) {
                                player.loadVideoById(currentVideoId);
                              }
                            }
                            break;
                        }
                      });

                      // Browser navigation
                      window.addEventListener('popstate', () => {
                        const params = getUrlParams();
                        if (params.videoId && params.videoId !== currentVideoId) {
                          loadVideo(params.videoId);
                          if (params.playlistId && params.playlistId !== currentPlaylistId) {
                            loadPlaylist(params.playlistId, params.index);
                          } else if (params.playlistId && playlistData) {
                            currentPlaylistIndex = params.index || 0;
                            updatePlaylistProgress();
                            highlightCurrentVideo();
                          }
                        }
                      });

                      // Format menu toggle
                      formatBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleFormatMenu();
                      });

                      // Close format menu when clicking outside
                      document.addEventListener('click', (e) => {
                        if (!formatSelector.contains(e.target)) {
                          formatMenu.classList.remove('open');
                        }
                      });

                      // Error retry button
                      errorRetryBtn.addEventListener('click', () => {
                        if (currentVideoId) {
                          tryProxyPlayer(currentVideoId);
                        }
                      });

                      // Proxy video events
                      proxyVideo.addEventListener('ended', handleProxyVideoEnded);

                      proxyVideo.addEventListener('error', (e) => {
                        console.error('Proxy video error:', e);
                        if (currentProxyFormat) {
                          showToast('Playback error. Try selecting a different quality.');
                        }
                      });
                    }

                    // Init
                    document.addEventListener('DOMContentLoaded', () => {
                      setupEventListeners();
                      setupScrollHandlers();

                      // Check if YouTube API is ready
                      if (window.YT?.Player) {
                        onYouTubeIframeAPIReady();
                      }
                    });

                    // Fallback timeout for YouTube API
                    setTimeout(() => {
                      if (!playerReady) {
                        const params = getUrlParams();
                        if (!params.videoId && !params.playlistId) {
                          hideSkeleton();
                        }
                      }
                    }, 3000);
                  </script>
                </body>
                </html>
